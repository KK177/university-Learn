[TOC]

## DHCP协议

### 主机如何获得IP地址

通过静态配置或者是动态配置

静态配置：比如在机房里，机房的管理员已经事先给每台主机都配置好了IP地址，子网掩码以及默认网关（默认网关指的是在这个局域网内主机连着的路由器）

动态配置：当我们拿着电脑每到一个地方，那么DHCP服务器就会给我们的电脑分配一个IP地址，当我们离开时，刚才分配的IP地址就会被回收

![image-20210520182844937](计网笔记网络层2.assets/image-20210520182844937.png)

### DHCP协议

动态主机配置协议DHCP是**应用层**协议，使用**客户/服务器**方式，客户端和服务端通过**广播**方式进行交互，基于**UDP**

DHCP提供**即插即用**联网的机制，主机🉑️以从服务器动态获取IP地址，子网掩码，默认网关，DNS服务器名称与IP地址，允许**地址重用**（地址重用是指当主机1进入到DHCP服务器的范围内，DHCP服务器会给主机1分配一个IP地址，当主机1离开时，那么该IP地址会被回收，当主机2进入到该范围内时，DHCP服务器🉑️以把刚才的那个IP地址分配给主机2），支持**移动用户加入网络**，支持**在用地址续租**（DHCP服务器分配的IP地址不是永久性的，一定时间内会被回收的）

过程

1.主机广播DHCP发现报文——看旁边是否有DHCP服务器

2.DHCP服务器广播DHCP提供报文——告诉主机这里有DHCP服务器，并且会拟分配一个IP地址及相关配置过去（假如主机1收到了3个DHCP服务器发来的IP地址，那么主机1会接收最先到达的地址）

3.主机广播DHCP请求报文——主机向服务器请求IP地址（用广播的原因：那么别的服务器也会知道我刚分配出去的IP地址，那个主机是不用的，那么就会将刚分配的回收回来）

4.DHCP服务器广播DHCP确认报文

![image-20210520183611253](计网笔记网络层2.assets/image-20210520183611253.png)

## ICMP协议

### 网际控制报文协议ICMP

ICMP协议支持主机或路由器

功能有：差错报告和网络探询（差错报告是指：当收到错误的分组时，会产生一个差错报告并把分组丢弃）

ICMP报文分类ICMP差错报文和ICMP询问报文

ICMP报文是封装在IP数据报的数据部分里的

![image-20210520190153982](计网笔记网络层2.assets/image-20210520190153982.png)

### ICMP差错报告报文

有5种

1.终点不🉑️达🙅‍♂️（数据出错等情况）

2.源点抑制（拥塞丢数据）（不过现在一般没用了）

3.时间超过

4.参数问题

5.改变路由

![image-20210520190810642](计网笔记网络层2.assets/image-20210520190810642.png)

### ICMP差错报告报文数据字段

将收到的IP数据报的数据字段的首部和前面8个字节拿出来，然后在前面添加ICMP的前8字节，这就形成ICMP差错报告报文，然后再重新装入IP数据报的数据部分

![image-20210520191146263](计网笔记网络层2.assets/image-20210520191146263.png)

### 不应发送ICMP差错报文的情况

组播地址：跟广播地址是有区别的，组播是一对多发送，但是可以选择发送到哪几台目的主机上

![image-20210520191752149](计网笔记网络层2.assets/image-20210520191752149.png)

### ICMP询问报文

![image-20210520192200202](计网笔记网络层2.assets/image-20210520192200202.png)

### ICMP的应用

PING IP地址 🉑️以测试两个主机之间的连通性

Traceroute 跟踪一个分组从源点到终点的路径（比如一连串的分组里面，发送的第一个分组设置TTL为1，那么分组经过第一个路由器就先把这个分组的TTL➖1，然后发送一个ICMP时间超过差错报告报文，那么类推下去，就会知道最后那个分组的全部路径了）

![image-20210520192746595](计网笔记网络层2.assets/image-20210520192746595.png)

## IPv6

### 为什么有IPv6

由于IPv4的地址几乎耗尽，那么IPv6就是从根本上解决问题，增大地址位数来扩充地址空间

![image-20210522142436679](计网笔记网络层2.assets/image-20210522142436679.png)

### IPv6的数据报格式

IPv4的首部是包含固定部分和🉑️变部分的，而IPv6数据报的首部是固定40字节的，而有效载荷里包括扩展首部的内容以及数据部分，这样的好处是，当原本IPv4中利用到的🉑️变部分的内容就可以直接写进扩展首部，而不是把所有有可能的🉑️变内容都写进，这样改进了首部格式，利于快速处理数据

![image-20210522142711942](计网笔记网络层2.assets/image-20210522142711942.png)

IPv6的基本首部

1.版本：指明了协议版本，版本是6

2.优先级：指明该数据报的优先级

3.流标签：同一个流的数据报都有同样的流标签（流：指互联网上从特定源点到特定终点的一系列数据报）

4.有效载荷长度：指的是有效载荷的长度

5.下一跳地址：首部的下一跳地址是扩展首部中的头，扩展首部的尾下一跳地址是数据部分

6.跳数限制：相当于IPv4里的TTL，当跳数为0时，路由器就会丢低该数据报，并发送一个超时的ICMP差错报告

![image-20210522143533409](计网笔记网络层2.assets/image-20210522143533409.png)

### IPv4与IPv6的区别

IPv6支持即插即用（即自动配置），在局域网里会自动分配一个IP地址，不像IPv4要经过DHCP服务器分配一个IP地址

IPv6只能在主机出分片，因此当在链路上传输的数据报过大，路由器无法缓存转发，那么路由器只好将数据报丢弃，然后转发一个ICMPv6差错报告

![image-20210522144414905](计网笔记网络层2.assets/image-20210522144414905.png)

### IPV6地址表示形式

![image-20210522144838622](计网笔记网络层2.assets/image-20210522144838622.png)

### IPv6基本地址类型

多播跟IPv4的广播地址不一样，广播是对特定局域网内的所有主机进行通信，多播是对特定局域网内的多个特定主机进行通信

![image-20210522145044124](计网笔记网络层2.assets/image-20210522145044124.png)

### IPv6和IPv4之间的过渡

有两种方式🉑️以实现过渡：双栈协议和隧道技术

双栈协议：是指主机或者路由器的每一个接口都同时分配有IPv4地址和IPv6地址，并具备同时处理这两个协议地址的功能

隧道技术：将IPv6的数据报包装成IPv4的数据报，然后在链路上传输（反过来也一样）

![image-20210522145510084](计网笔记网络层2.assets/image-20210522145510084.png)

### IPv6总结🌟

![image-20210522150024467](计网笔记网络层2.assets/image-20210522150024467.png)

## 路由算法和路由选择协议

### 路由算法

路由器会遵循路由协议，然后利用路由算法来规划处最佳路径

![image-20210517204319606](计网笔记网络层2.assets/image-20210517204319606.png)

### 路由算法的分类

路由算法分为 静态路由算法和动态路由算法

静态路由算法：在通信之前，管理员就已经手工配置好路由信息，但这种路由算法更新慢，只适用于拓扑变化不大的网络

动态路由算法：路由器之前彼此交换信息，按照路由算法优化处路由表项，这种路由算法更新快，适用于大型网络

动态路由算法分为 全局性和分散性

全局性：所有路由器掌握完整的网络拓扑和链路费用信息

分散性：路由器只掌握物理相连的邻居及链路费用

![image-20210517204812063](计网笔记网络层2.assets/image-20210517204812063.png)

### 分层次的路由选择协议

因特网的规模很大，那么就细分为一个个自治系统AS

自治系统AS内使用的路由协议外部是看不见的

![image-20210517205434693](计网笔记网络层2.assets/image-20210517205434693.png)

## RIP协议与距离向量算法

### 路由选择协议分类回顾

在自治系统内，外部是看不见内部协议的

而内部网关协议IGP一般使用两个协议，一个是RIP，一个是OSPF。（RIP和OSPF的路由算法不一样，RIP使用的是距离向量算法，OSPF使用的是链路状态算法，而RIP适用于小范围的自治系统）

![image-20210522151322779](计网笔记网络层2.assets/image-20210522151322779.png)

### RIP协议

RIP是一种分布式的基于**距离向量**的路由选择协议，是因特网的协议标准，最大优点是**简单**

RIP协议要求网络中的每一个路由器中的路由表都维护从它自己到其他网络的**唯一最佳距离记录**

RIP允许一条路由最多只能包含15个路由器，因此**距离为16表示网络不🉑️达**，所以RIP协议只适用于**小互联网**

![image-20210522152056033](计网笔记网络层2.assets/image-20210522152056033.png)

### RIP协议的工作内容

遵循RIP协议的路由器是通过和**相邻路由器**交换信息来更新自己的路由表的

路由器会给邻居发送一个**RIP报文**，该报文里就是自己路由表的全部信息

每30秒交换一次路由信息，然后路由器根据新信息更新路由表。若超过180s没收到邻居路由器的通告，则判断邻居没了，链路出了问题，那么路由器就会更新自己的路由表

路由表经过若干次更新之后，所有路由器最终都会知道本自治系统内任何一个网络的最短距离和下一跳路由器的地址，即“收敛”

![image-20210522152934742](计网笔记网络层2.assets/image-20210522152934742.png)

### 距离向量算法

路由器收到邻居发来的RIP报文，首先做的是先修改该报文中的所有项，修改完之后再与自己本身的路由表的信息进行对比，然后再进行修改

![image-20210522154004813](计网笔记网络层2.assets/image-20210522154004813.png)

![image-20210522154410615](计网笔记网络层2.assets/image-20210522154410615.png)

![image-20210522154845456](计网笔记网络层2.assets/image-20210522154845456.png)

### RIP协议的报文格式

RIP是应用层协议，使用UDP传送数据（UDP是传输层协议，是面向🈚️连接的）

当路由器里的路由表信息超过25项时，就要再用多一个RIP报文进行传输

![image-20210522155018997](计网笔记网络层2.assets/image-20210522155018997.png)

### RIP协议好消息传得快，坏消息传得慢

![image-20210522160047073](计网笔记网络层2.assets/image-20210522160047073.png)

### 总结🌟

![image-20210522160154981](计网笔记网络层2.assets/image-20210522160154981.png)

## OSPF协议与链路状态算法

### OSPF协议

OSPF协议叫做开放最短路径优先协议：“开放”标明OSPF协议不是受一家厂商控制的，而是公开发表的，“最短路径优先”是因为使用了Dijkstra提出的**最短路径算法SPF**

OSPF最主要的特征就是使用分布式的**链路状态协议**

OSPF的特点：
1.使用洪泛法向自治系统内所有路由器发送信息，即路由器通过输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器

2.发送的信息就是与本路由器相邻的所有路由器的链路状态（本路由器和哪些路由器相邻，以及该链路的度量/代价——费用，距离，时延，带宽等）

3.只有当**链路状态发生变化时**，路由器才向所有路由器洪泛发送此信息

最后，所有路由器都能建立一个**链路状态数据库**，即**全网拓扑图**

![image-20210523134950626](计网笔记网络层2.assets/image-20210523134950626.png)

### 链路状态路由算法

1.首先路由器会发送HELLO问候分组给邻居结点，并了解邻居结点的网络地址（包括了解网络是否🉑️达等）

2.然后会设置到每个邻居的成本度量metric

3.然后构造一个【DD数据库描述分组】，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息

4.当邻居收到该数据库描述分组时，如果DD分组中的摘要自己都有，则邻站不做处理；如果有没有的或者是更新的，则发送【LSR链路状态请求分组】，请求自己没有的和比自己更新的信息

5.收到邻站的LSR分组后，发送【LSU链路状态更新分组】进行更新

6.更新完毕后，邻站返回一个【LSAck链路状态确认分组】进行确认

只要一个路由器的链路状态发生变化：

1.路由器就会洪泛发送【LSU链路状态更新分组】进行更新

2.更新完毕后，其他站返回一个【LSAck链路状态确认分组】进行确认

3.然后使用Dijkstra根据自己的链路状态数据库构造到其他节点间的最短路径

![image-20210523140130741](计网笔记网络层2.assets/image-20210523140130741.png)

### OSPF的区域

OSPF将一个自治系统再划分为若干个更小的范围，叫做区域，划分之后，每个区域内部的信息交流量大大减少，利于构建更大规模的网络

![image-20210523141340611](计网笔记网络层2.assets/image-20210523141340611.png)

### OSPF分组

![image-20210523141623757](计网笔记网络层2.assets/image-20210523141623757.png)

### OSPF其他特点

每隔30min，会刷新一次数据库中的链路状态

由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并🈚️直接关系。因此当**互联网规模很大**时，OSPF协议要比距离向量协议RIP好得多（而且当跳数>=16时，RIP协议就会将链路视为不🉑️达）

OSPF不存在坏消息传得慢的问题，它的**收敛速度很快**（OSPF协议是使用Dijkstra算法来根据自己的链路状态库来得出到每个节点的最短路径，当某个节点出现故障，是可以第一时间知道的）

![image-20210523143012905](计网笔记网络层2.assets/image-20210523143012905.png)

## BGP协议

![image-20210523144310849](计网笔记网络层2.assets/image-20210523144310849.png)

### BGP协议

与其他AS的邻站BGP发言人交换信息

交换的是网络的🉑️达性的信息，即要到达某个网络所要经过的一系列AS

发生变化时更新有变化的部分

![image-20210523144951987](计网笔记网络层2.assets/image-20210523144951987.png)

### BGP协议交换信息的过程

![image-20210523145248445](计网笔记网络层2.assets/image-20210523145248445.png)

![image-20210523145418684](计网笔记网络层2.assets/image-20210523145418684.png)

![image-20210523145436179](计网笔记网络层2.assets/image-20210523145436179.png)

### BGP协议报文格式

![image-20210523145600731](计网笔记网络层2.assets/image-20210523145600731.png)

### BGP协议特点

![image-20210523145840728](计网笔记网络层2.assets/image-20210523145840728.png)

### BGP-4的四种报文

![image-20210523150048659](计网笔记网络层2.assets/image-20210523150048659.png)

### 三种路由协议比较

![image-20210523150249732](计网笔记网络层2.assets/image-20210523150249732.png)

![image-20210523150832633](计网笔记网络层2.assets/image-20210523150832633.png)

## IP组播

### IP数据报的三种传输方式

组播：是对网络中的某些特定用户发送特定数据。在链路上传输时还只是一个数据报，但到了连接这些特定用户的节点处才开始对数据报进行复制和分发

![image-20210525134346460](计网笔记网络层2.assets/image-20210525134346460.png)

### IP组播地址

属于多播组的设备将被分配一个**组播IP地址**（一群共同需求主机的相同标识）

![image-20210525135819685](计网笔记网络层2.assets/image-20210525135819685.png)

### 硬件组播

由于D类地址大多数应用于组播地址，因此，假如A，B，C三台主机正在观看一个主播的视频，那么服务器那边就会把数据报发送给一个组播地址（A，B，C的组播地址是一样的），当到达一个局域网内时，路由器回将这个组播地址映射成MAC地址（组播MAC地址的前6位是固定好的，然后将组播地址的后23位映射映射到MAC地址的后23位就可以了）

但是这样出现一种情况：就是主机A，B在看两个不同的主播的视频，而主机A，B的组播地址的后23位是一样的，那么到一个局域网内时（A，B在同一个局域网内），映射到组播MAC地址是一样的，那么主机A，B都会同时收到来自两个主播的数据报，这种情况下，就需要主机的IP层利用软件进行过滤，把不是本主机要接收的数据报丢弃

![image-20210525141018359](计网笔记网络层2.assets/image-20210525141018359.png)

### IGMP协议与组播路由选择协议

这两个协议是应用在因特网范围内组播的

IGMP协议是用于组播路由器上，这🉑️以让组播路由器知道它所管理的局域网范围内还有没有主机是要接收组播数据报的

组播路由选择协议：也是应用在路由器上的，这🉑️以让路由器在分发组播数据报时🉑️以有一个更好的路由选择

![image-20210525142434072](计网笔记网络层2.assets/image-20210525142434072.png)

### 网际组管理协议IGMP

IGMP协议让路由器知道本局域网上是否有主机（的进程）参加或退出了某个组播组

路由器根据IGMP协议知道R4路由器下没有主机参加了组播组，那么就不会将数据报转发给它

![image-20210525143900377](计网笔记网络层2.assets/image-20210525143900377.png)

#### IGMP工作的两个阶段

![image-20210525144619592](计网笔记网络层2.assets/image-20210525144619592.png)

### 组播路由选择协议

![image-20210525144840127](计网笔记网络层2.assets/image-20210525144840127.png)

![image-20210525144949536](计网笔记网络层2.assets/image-20210525144949536.png)

### 总结🌟

![image-20210525145038019](计网笔记网络层2.assets/image-20210525145038019.png)

